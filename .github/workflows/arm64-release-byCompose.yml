name: Get-AMD64-Docker-Images-Compose-Release

on:
  workflow_dispatch:
    inputs:
      compose_file_path:
        description: 'è¯·è¾“å…¥ docker-compose æ–‡ä»¶è·¯å¾„ï¼ˆå¦‚ï¼šdocker-compose.yml æˆ– docker-compose.yamlï¼‰'
        required: true
        default: 'docker-compose.yml'

jobs:
  pull_and_package:
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install yq for YAML parsing
        run: |
          sudo apt-get update && sudo apt-get install -y curl jq
          curl -sSLo /usr/local/bin/yq https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
          chmod +x /usr/local/bin/yq

      - name: Find docker-compose file (support .yml and .yaml)
        run: |
          COMPOSE_FILE="${{ github.event.inputs.compose_file_path }}"
          echo "ğŸ” Looking for docker-compose file at: $COMPOSE_FILE"

          # æ£€æŸ¥ç”¨æˆ·è¾“å…¥çš„æ–‡ä»¶æ˜¯å¦å­˜åœ¨
          if [ -f "$COMPOSE_FILE" ]; then
            echo "âœ… Found: $COMPOSE_FILE"
            echo "COMPOSE_FILE_PATH=$COMPOSE_FILE" >> $GITHUB_ENV
            exit 0
          fi

          # å¦‚æœæ²¡æ‰¾åˆ°ï¼Œå°è¯•è‡ªåŠ¨æœç´¢ .yml å’Œ .yaml
          echo "âš ï¸ File not found. Searching for docker-compose.{yml,yaml}..."

          # ä½¿ç”¨ find æœç´¢ä¸¤ä¸ªåç¼€
          found_file=$(find . -type f -name "docker-compose.yml" -o -name "docker-compose.yaml" | head -1)

          if [ -n "$found_file" ]; then
            echo "âœ… Found: $found_file"
            echo "COMPOSE_FILE_PATH=$found_file" >> $GITHUB_ENV
            exit 0
          else
            echo "âŒ Error: No docker-compose.yml or docker-compose.yaml found in the repository."
            exit 1
          fi

      - name: Validate docker-compose file
        run: |
          COMPOSE_FILE="${COMPOSE_FILE_PATH}"
          echo "ğŸ§ª Validating $COMPOSE_FILE..."
          yq -e '.services' "$COMPOSE_FILE" >/dev/null 2>&1
          if [ $? -ne 0 ]; then
            echo "âŒ Error: Invalid YAML or missing 'services' section."
            exit 1
          fi
          echo "âœ… Validation passed."

      - name: Parse docker-compose file for images (with safe filtering)
        run: |
          COMPOSE_FILE="${COMPOSE_FILE_PATH}"
          echo "ğŸ” Parsing images from $COMPOSE_FILE..."

          # ä½¿ç”¨ yq æå–æ‰€æœ‰ image å­—æ®µï¼Œä½†åªä¿ç•™ä¸åŒ…å«å†’å·çš„ï¼ˆæˆ–ç¬¦åˆ Docker é•œåƒæ ¼å¼çš„ï¼‰
          # æˆ‘ä»¬ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼è¿‡æ»¤ï¼šåªä¿ç•™å½¢å¦‚ `xxx/xxx:tag` æˆ– `xxx:tag` çš„åˆæ³•é•œåƒ
          # æ³¨æ„ï¼šæˆ‘ä»¬è·³è¿‡åŒ…å« `:` ä½†ä¸æ˜¯é•œåƒæ ¼å¼çš„ï¼ˆå¦‚ env å˜é‡ï¼‰

          images=$(yq -r '
            .services | to_entries[] | select(.value.image != null) |
            .value.image | select(test("^[a-zA-Z0-9._-]+[/][a-zA-Z0-9._-]+[/]?[a-zA-Z0-9._-]*[:][a-zA-Z0-9._-]+$")) |
            . as $img | 
            # å»é™¤å¯èƒ½çš„ ${VAR:default} æ ¼å¼ï¼ˆå¦‚ env å˜é‡ï¼‰
            if $img | test("\\$\\{.*\\}") then
              empty
            else
              $img
            end
          ' "$COMPOSE_FILE" | sort -u)

          # å¦‚æœæ²¡æœ‰æ‰¾åˆ°åˆæ³•é•œåƒ
          if [ -z "$images" ]; then
            echo "âš ï¸ No valid images found in $COMPOSE_FILE"
            exit 0
          fi

          # è¾“å‡ºæ—¥å¿—
          echo "ğŸ“¦ Found valid images:"
          echo "$images" | tr ' ' '\n'

          # å†™å…¥ç¯å¢ƒå˜é‡
          echo "DOCKER_IMAGES=$images" >> $GITHUB_ENV


      - name: Pull Docker Images and Package (AMD64)
        run: |
          images="${DOCKER_IMAGES}"
          IFS=',' read -r -a image_array <<< "$images"

          for image in "${image_array[@]}"; do
            echo "ğŸ“¥ Pulling $image for linux/amd64..."
            docker pull "${image}" --platform "linux/amd64"
            if [ $? -ne 0 ]; then
              echo "âš ï¸ Failed to pull $image. Skipping..."
              continue
            fi

            # æ„é€ æ–‡ä»¶åï¼šæ›¿æ¢ / å’Œ : ä¸º _
            image_name="${image//\//_}"
            image_name="${image_name//:/_}"
            tar_file="${image_name}-amd64.tar"
            gz_file="${tar_file}.gz"

            # ä¿å­˜é•œåƒ
            docker save "${image}" -o "$tar_file"
            gzip -c "$tar_file" > "$gz_file"
            rm "$tar_file"

            echo "âœ… Saved $gz_file"
          done

      - name: List generated files (debug)
        run: |
          echo "ğŸ“¦ Generated files:"
          find . -name "*.tar.gz" -print

      - name: Generate release name
        run: |
          release_name=$(TZ="Asia/Shanghai" date +'%Y-%m-%d %H:%M Build')
          echo "RELEASE_NAME=$release_name" >> $GITHUB_ENV

      - name: Create GitHub Release
        uses: softprops/action-gh-release@master
        with:
          tag_name: DockerTarBuilder-AMD64
          name: ${{ env.RELEASE_NAME }} for x86-64
          body: |
            [![Github](https://img.shields.io/badge/RELEASE:DockerTarBuilder-123456?logo=github&logoColor=fff&labelColor=green&style=for-the-badge)](https://www.bilibili.com/video/BV1EZ421M7mL) [![Github](https://img.shields.io/badge/å›½å†…åŠ é€Ÿç«™ä¸‹è½½-FC7C0D?logo=github&logoColor=fff&labelColor=000&style=for-the-badge)](https://wkdaily.cpolar.top/archives/2025/04/10/docker-compose-mirror/)
            ### ğŸ“¦ è¿™äº›é•œåƒæ¥è‡ªä½ çš„ `docker-compose.yml` æˆ– `docker-compose.yaml`ï¼Œå·²æ‰“åŒ…ä¸º AMD64 æ ¼å¼ï¼Œé€‚ç”¨äº Windows
            - ä½¿ç”¨æ–¹æ³•ï¼š`docker load -i <filename>.tar.gz`
            - è¯·ç¡®ä¿ä½ çš„ Docker Desktop æ”¯æŒ Linux å®¹å™¨æ¨¡å¼
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload Docker images as release assets
        uses: actions/upload-release-asset@v1
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: ${{ github.workspace }}/*.tar.gz
          asset_name: ${{ github.event.inputs.compose_file_path }}-amd64.tar.gz
          asset_content_type: application/gzip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
