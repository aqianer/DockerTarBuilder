name: Download Wheels (Auto-Resolve)

on:
  workflow_dispatch:
    inputs:
      release_tag:
        description: 'Release tag (e.g., v1.0.0)'
        required: true
        default: 'v0.1.0'
      wheel_names:
        description: |
          Comma-separated list of wheel filenames (e.g.,
          watchdog-6.0.0-cp39-cp39-manylinux2014_x86_64.whl,
          requests-2.31.0-py3-none-any.whl)
        required: true
        default: ''

jobs:
  download-wheels:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Install pip-tools (for pip download)
        run: |
          python -m pip install --upgrade pip
          pip install pip-tools

      - name: Prepare wheel list (convert .whl to package==version)
        id: parse_wheels
        run: |
          input="$INPUT_WHEEL_NAMES"
          wheels=()

          # ÂàÜÂâ≤ËæìÂÖ•
          IFS=',' read -ra WHEEL_ARRAY <<< "$input"

          for wheel in "${WHEEL_ARRAY[@]}"; do
            wheel=$(echo "$wheel" | xargs)  # ÂéªÈô§È¶ñÂ∞æÁ©∫Ê†º
            if [[ -z "$wheel" ]]; then
              continue
            fi

            # Ê≠£ÂàôÂåπÈÖç: <package>-<version>[-...].whl
            if [[ "$wheel" =~ ^([a-zA-Z0-9_-]+)-([0-9]+\.[0-9]+\.[0-9]+) ]]; then
              pkg_name="${BASH_REMATCH[1]}"
              version="${BASH_REMATCH[2]}"
              wheels+=("$pkg_name==$version")
              echo "‚úÖ Matched: $wheel ‚Üí $pkg_name==$version"
            else
              echo "‚ùå Failed to parse: $wheel"
            fi
          done

          # ËæìÂá∫ÊúÄÁªàÂàóË°®
          if [ ${#wheels[@]} -eq 0 ]; then
            echo "‚ö†Ô∏è  No valid wheel names found."
            exit 1
          fi

          # ÂÜôÂÖ•ÁéØÂ¢ÉÂèòÈáè
          echo "WHEELS=$(printf '%s ' "${wheels[@]}")" >> $GITHUB_ENV
          echo "üîç Downloading: $WHEELS"

      - name: Create wheels directory
        run: mkdir -p ./wheels

      - name: Download wheels using pip download
        run: |
          echo "üöÄ Starting pip download..."
          echo "Packages to download: $WHEELS"
          echo "$WHEELS" | xargs -I {} sh -c 'pip download --dest ./wheels --no-deps {}'
          echo "‚úÖ All wheels downloaded to ./wheels/"

      - name: List downloaded wheels
        run: |
          echo "üìÅ Contents of ./wheels:"
          ls -la ./wheels/

      - name: Upload wheels as artifact
        uses: actions/upload-artifact@v4
        with:
          name: wheels-${{ inputs.release_tag }}
          path: ./wheels/
          if-no-files-found: ignore

      - name: Create GitHub Release
        id: create_release
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = require('path');

            // ËØªÂèñ‰∏ãËΩΩÁöÑ wheel Êñá‰ª∂
            const wheelDir = './wheels';
            const files = fs.readdirSync(wheelDir).filter(file => file.endsWith('.whl'));

            if (files.length === 0) {
              console.log('‚ö†Ô∏è  No wheel files found to upload.');
              return;
            }

            const releaseTag = process.env.RELEASE_TAG || context.ref.replace('refs/tags/', '');
            const releaseName = `Release ${releaseTag}`;

            const { data: release } = await github.rest.repos.createRelease({
              owner: context.repo.owner,
              repo: context.repo.repo,
              tag_name: releaseTag,
              name: releaseName,
              body: `Automated release with wheels for ${files.join(', ')}.`,
              draft: false,
              prerelease: false,
            });

            console.log(`‚úÖ Release created: ${release.html_url}`);

            // ‰∏ä‰º†ÊØè‰∏™ wheel Êñá‰ª∂
            for (const file of files) {
              const filePath = path.join(wheelDir, file);
              const fileContent = fs.readFileSync(filePath);

              await github.rest.repos.uploadReleaseAsset({
                owner: context.repo.owner,
                repo: context.repo.repo,
                release_id: release.id,
                name: file,
                data: fileContent,
              });
              console.log(`üì§ Uploaded: ${file}`);
            }

      - name: Print success message
        run: |
          echo "üéâ Workflow completed successfully!"
          echo "üì¶ Wheels uploaded to release: ${{ steps.create_release.outputs.url }}"
