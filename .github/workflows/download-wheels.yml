name: Download Wheels (Auto-Resolve)

on:
  workflow_dispatch:
    inputs:
      release_tag:
        description: 'Release tag (e.g., v1.0.0)'
        required: true
        default: 'v0.1.0'
      wheel_names:
        description: |
          Comma-separated list of wheel filenames (e.g.,
          watchdog-6.0.0-cp39-cp39-manylinux2014_x86_64.whl,
          requests-2.31.0-py3-none-any.whl)
        required: true
        default: ''

jobs:
  download-wheels:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Install pip-tools (for pip download)
        run: |
          python -m pip install --upgrade pip
          pip install pip-tools

      - name: Prepare wheel list (robust version)
        id: parse_wheels
        run: |
          # è·å–è¾“å…¥å¹¶æ¸…ç†
          input=$(echo "$INPUT_WHEEL_NAMES" | tr -d '\n\r' | xargs)  # å»é™¤æ¢è¡Œã€å›è½¦ã€é¦–å°¾ç©ºæ ¼
          wheels=()

          # åˆ†å‰²ï¼ˆæ”¯æŒé€—å·åˆ†éš”ï¼Œå…è®¸ç©ºæ ¼ï¼‰
          IFS=',' read -ra WHEEL_ARRAY <<< "$input"

          for wheel in "${WHEEL_ARRAY[@]}"; do
            wheel=$(echo "$wheel" | xargs)  # å»é™¤å‰åç©ºæ ¼
            if [[ -z "$wheel" ]]; then
              continue
            fi

            # æ›´å¼ºçš„æ­£åˆ™ï¼šåŒ¹é… package-version ç»“æ„ï¼Œå¿½ç•¥åé¢çš„ cpXXXã€manylinux ç­‰
            if [[ "$wheel" =~ ^([a-zA-Z0-9_-]+)-([0-9]+\.[0-9]+\.[0-9]+)(?:-[a-zA-Z0-9_.]+)*\.whl$ ]]; then
              pkg_name="${BASH_REMATCH[1]}"
              version="${BASH_REMATCH[2]}"
              wheels+=("$pkg_name==$version")
              echo "âœ… Matched: $wheel â†’ $pkg_name==$version"
            else
              echo "âŒ Failed to parse: $wheel"
              echo "  Hint: Expected format: package-version-cpXX-...whl"
            fi
          done

          # æ£€æŸ¥æ˜¯å¦æœ‰æœ‰æ•ˆ wheel
          if [ ${#wheels[@]} -eq 0 ]; then
            echo "âš ï¸  No valid wheel names found after parsing."
            echo "  Please check your input format and ensure it's comma-separated."
            echo "  Example: watchdog-6.0.0-cp39-cp39-manylinux2014_x86_64.whl,requests-2.31.0-py3-none-any.whl"
            exit 1
          fi

          # è¾“å‡ºåˆ°ç¯å¢ƒå˜é‡
          echo "WHEELS=$(printf '%s ' "${wheels[@]}")" >> $GITHUB_ENV
          echo "ğŸ” Final packages to download: $WHEELS"


      - name: Create wheels directory
        run: mkdir -p ./wheels

      - name: Download wheels using pip download
        run: |
          echo "ğŸš€ Starting pip download..."
          echo "Packages to download: $WHEELS"
          echo "$WHEELS" | xargs -I {} sh -c 'pip download --dest ./wheels --no-deps {}'
          echo "âœ… All wheels downloaded to ./wheels/"

      - name: List downloaded wheels
        run: |
          echo "ğŸ“ Contents of ./wheels:"
          ls -la ./wheels/

      - name: Upload wheels as artifact
        uses: actions/upload-artifact@v4
        with:
          name: wheels-${{ inputs.release_tag }}
          path: ./wheels/
          if-no-files-found: ignore

      - name: Create GitHub Release
        id: create_release
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = require('path');

            // è¯»å–ä¸‹è½½çš„ wheel æ–‡ä»¶
            const wheelDir = './wheels';
            const files = fs.readdirSync(wheelDir).filter(file => file.endsWith('.whl'));

            if (files.length === 0) {
              console.log('âš ï¸  No wheel files found to upload.');
              return;
            }

            const releaseTag = process.env.RELEASE_TAG || context.ref.replace('refs/tags/', '');
            const releaseName = `Release ${releaseTag}`;

            const { data: release } = await github.rest.repos.createRelease({
              owner: context.repo.owner,
              repo: context.repo.repo,
              tag_name: releaseTag,
              name: releaseName,
              body: `Automated release with wheels for ${files.join(', ')}.`,
              draft: false,
              prerelease: false,
            });

            console.log(`âœ… Release created: ${release.html_url}`);

            // ä¸Šä¼ æ¯ä¸ª wheel æ–‡ä»¶
            for (const file of files) {
              const filePath = path.join(wheelDir, file);
              const fileContent = fs.readFileSync(filePath);

              await github.rest.repos.uploadReleaseAsset({
                owner: context.repo.owner,
                repo: context.repo.repo,
                release_id: release.id,
                name: file,
                data: fileContent,
              });
              console.log(`ğŸ“¤ Uploaded: ${file}`);
            }

      - name: Print success message
        run: |
          echo "ğŸ‰ Workflow completed successfully!"
          echo "ğŸ“¦ Wheels uploaded to release: ${{ steps.create_release.outputs.url }}"
